drop view VW_BUSCADIFERENCASALDOFINALBANCOSNAOCOMPOE_2023;

create or replace view VW_BUSCADIFERENCASALDOFINALBANCOSNAOCOMPOE_2023 AS
SELECT X.ANO, X.USUARIO, X.FICHA, X.FONTERECURSO, SUM(X.SALDOFINALCTB) AS SALDOFINALCTB, SUM(X.SALDOFINALBAL) AS SALDOFINALBAL
FROM (

SELECT ANO, USUARIO, CAST(SEQ5 AS integer) AS FICHA, SEQ6 AS FONTERECURSO, SUM(CAST(REPLACE(SEQ12, ',', '.') AS DECIMAL(15,2)) * (CASE WHEN SEQ13 = 'C' THEN -1 ELSE 1 END)) AS SALDOFINALBAL, 0 AS SALDOFINALCTB
FROM TCE_SICOM 
WHERE ARQUIVO = 'BALANCETE'
AND SEQ1 = '17'
AND (SEQ4 = 'P' OR SUBSTRING(SEQ2,1,3) LIKE '114' OR SUBSTRING(SEQ2,1,2) LIKE '12')
AND (SUBSTRING(SEQ2,1,7) NOT LIKE '1111101' OR SUBSTRING(SEQ2,1,7) NOT LIKE '1111102' OR SUBSTRING(SEQ2,1,6) NOT LIKE '111113' OR SUBSTRING(SEQ2,1,7) NOT LIKE '1112101' OR SUBSTRING(SEQ2,1,4) NOT LIKE '1113')
GROUP BY ANO, USUARIO, CAST(SEQ5 AS integer), SEQ6 

UNION ALL

SELECT ANO, USUARIO, CAST(SEQ3 AS integer) AS FICHA, SEQ4 AS FONTERECURSO, 0, SUM(CAST(REPLACE(SEQ7, ',', '.') AS DECIMAL(15,2)))
FROM TCE_SICOM 
WHERE MODULO = 'AM'
AND ARQUIVO = 'CTB'
AND SEQ1 = '20'
AND SEQ5 = '2'
GROUP BY  ANO, USUARIO, CAST(SEQ3 AS integer), SEQ4

) X
WHERE 1=1
AND X.ANO = 2023
GROUP BY X.ANO, X.USUARIO, X.FICHA, X.FONTERECURSO
HAVING SUM(X.SALDOFINALCTB) != SUM(X.SALDOFINALBAL);